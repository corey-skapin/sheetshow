name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag -replace '^v', ''
          echo "version=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      - name: Setup Flutter 3.24
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          pub-cache-key: "pub-${{ runner.os }}-${{ hashFiles('client/pubspec.yaml') }}"

      - name: Install dependencies
        working-directory: client
        run: flutter pub get

      - name: Cache build_runner outputs
        uses: actions/cache@v4
        with:
          path: |
            client/.dart_tool/build/
            client/lib/core/database/app_database.g.dart
          key: build-runner-${{ runner.os }}-${{ hashFiles('client/lib/**/*.dart', 'client/pubspec.yaml') }}
          restore-keys: |
            build-runner-${{ runner.os }}-

      - name: Generate Dart code (Drift)
        working-directory: client
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Dart format check
        working-directory: client
        run: dart format --set-exit-if-changed lib/ test/

      - name: Flutter analyze
        working-directory: client
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Run unit tests
        working-directory: client
        run: flutter test test/unit/

      - name: Build Windows release
        working-directory: client
        run: flutter build windows --release

      - name: Create MSIX package
        working-directory: client
        shell: pwsh
        run: |
          # Update msix_version to match the tag
          $ver = "${{ steps.version.outputs.version }}"
          $parts = $ver -split '\.'
          # Ensure 4-part version (x.y.z.0)
          while ($parts.Count -lt 4) { $parts += '0' }
          $msixVer = $parts[0..3] -join '.'
          $pubspec = Get-Content pubspec.yaml -Raw
          $pubspec = $pubspec -replace 'msix_version: [\d.]+', "msix_version: $msixVer"
          Set-Content pubspec.yaml $pubspec
          dart run msix:create

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $releaseDir = "client/build/windows/x64/runner/Release"
          Compress-Archive -Path "$releaseDir/*" -DestinationPath "SheetShow-${{ steps.version.outputs.version }}-windows-x64.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: SheetShow v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            client/build/windows/x64/runner/Release/SheetShow.msix
            SheetShow-${{ steps.version.outputs.version }}-windows-x64.zip
