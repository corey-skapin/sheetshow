name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag -replace '^v', ''
          echo "version=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      - name: Setup Flutter 3.24
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          pub-cache-key: "pub-${{ runner.os }}-${{ hashFiles('client/pubspec.yaml') }}"

      - name: Install dependencies
        working-directory: client
        run: flutter pub get

      - name: Cache build_runner outputs
        uses: actions/cache@v4
        with:
          path: |
            client/.dart_tool/build/
            client/lib/core/database/app_database.g.dart
          key: build-runner-${{ runner.os }}-${{ hashFiles('client/lib/**/*.dart', 'client/pubspec.yaml') }}
          restore-keys: |
            build-runner-${{ runner.os }}-

      - name: Generate Dart code (Drift)
        working-directory: client
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Dart format check
        working-directory: client
        run: dart format --set-exit-if-changed lib/ test/

      - name: Flutter analyze
        working-directory: client
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Run unit tests
        working-directory: client
        run: flutter test test/unit/

      - name: Build Windows release
        working-directory: client
        run: flutter build windows --release

      - name: Build Inno Setup installer
        working-directory: client
        shell: pwsh
        run: |
          # Inno Setup 6 is pre-installed on windows-latest runners
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            choco install innosetup -y --no-progress
            $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          }
          & $iscc /DMyAppVersion="${{ steps.version.outputs.version }}" installer.iss

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $releaseDir = "client/build/windows/x64/runner/Release"
          Compress-Archive -Path "$releaseDir/*" -DestinationPath "SheetShow-${{ steps.version.outputs.version }}-windows-x64-portable.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: SheetShow v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            client/Output/SheetShow-${{ steps.version.outputs.version }}-setup.exe
            SheetShow-${{ steps.version.outputs.version }}-windows-x64-portable.zip
