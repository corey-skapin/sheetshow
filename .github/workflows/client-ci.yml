name: Client CI

on:
  push:
    branches: [main, 'feat/**', 'refactor/**']
    paths:
      - 'client/**'
      - '.github/workflows/client-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'client/**'

jobs:
  format-check:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter 3.24
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          pub-cache-key: "pub-${{ runner.os }}-${{ hashFiles('client/pubspec.yaml') }}"
      - name: Dart format check
        working-directory: client
        run: dart format --set-exit-if-changed lib/ test/

  analyze-test-build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter 3.24
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          pub-cache-key: "pub-${{ runner.os }}-${{ hashFiles('client/pubspec.yaml') }}"

      - name: Install dependencies
        working-directory: client
        run: flutter pub get

      - name: Cache build_runner outputs
        uses: actions/cache@v4
        with:
          path: |
            client/.dart_tool/build/
            client/lib/core/database/app_database.g.dart
          key: build-runner-${{ runner.os }}-${{ hashFiles('client/lib/**/*.dart', 'client/pubspec.yaml') }}

      - name: Generate Dart code (Drift)
        working-directory: client
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Flutter analyze (zero warnings)
        working-directory: client
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Run unit tests with coverage
        working-directory: client
        run: flutter test --coverage test/unit/

      - name: Check coverage threshold (>= 60%)
        working-directory: client
        run: |
          $lcov = Get-Content coverage/lcov.info
          # Exclude Drift-generated files (*.g.dart) from the coverage calculation.
          $skip = $false
          $filtered = [System.Collections.Generic.List[string]]::new()
          foreach ($line in $lcov) {
            if ($line -match '^SF:(.+)') { $skip = $Matches[1] -match '\.g\.dart$' }
            if (-not $skip) { $filtered.Add($line) }
          }
          $linesHit = ($filtered | Where-Object { $_ -match '^DA:\d+,(\d+)' -and [int]$Matches[1] -gt 0 }).Count
          $linesTotal = ($filtered | Where-Object { $_ -match '^DA:\d+,' }).Count
          if ($linesTotal -gt 0) {
            $pct = [Math]::Round($linesHit / $linesTotal * 100, 1)
            Write-Host "Coverage (excluding generated files): $pct%"
            if ($pct -lt 60) { throw "Coverage $pct% is below 60% threshold." }
          }

      - name: Build Windows release
        working-directory: client
        run: flutter build windows --release
